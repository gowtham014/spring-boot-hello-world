pipeline {
    agent any
    parameters {
        string(name: 'ARTIFACT_VERSION', defaultValue: '1', description: 'Enter the version of the artifact to download from Nexus')
    }
    environment {
        SSH_USER = 'ubuntu'
        SSH_HOST = '15.207.16.183'
        NEXUS_URL = 'http://34.44.201.119:8081/repository/spring/DEV/hello/'
        ARTIFACT_PATH = '/home/ubuntu/spring-boot/' 
        ARTIFACT_NAME = "${params.ARTIFACT_VERSION}/hello-${params.ARTIFACT_VERSION}.jar"
    }
    stages {
        stage('Use PEM Key for SSH') {
            steps {
                withCredentials([file(credentialsId:'pem-key', variable: 'PEM_FILE')]) {
                    sh """
                    chmod 400 $PEM_FILE
                    ssh -i $PEM_FILE -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST 
                    cd $ARTIFACT_PATH
                    sh check.sh
                    rm -rf *.jar
                    wget $NEXUS_URL/$ARTIFACT_NAME
                    nohup java -jar hello-${params.ARTIFACT_VERSION}.jar > app.log 2>&1 &
                    """
                }
            }
        }
    }
}


